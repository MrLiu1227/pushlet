/*
 * jqupload v1.0 2017.6 by CSS WangWeidong
 */(function(d){d.fn.jqupload=function(a){a=d.extend({btnTitle:"\u8bf7\u9009\u62e9\u6587\u4ef6",btnAlign:"pull-left",btnClass:"btn-primary btn-sm",btnOnTop:!0,btnSortClass:"btn-default btn-sm",readonly:!1,confirm:!0,sortable:!1,sortSaveAuto:!1,fileIcon:!0,uploadUrl:"uploadAttachment.action",getUrl:"getAttachment.action",getCropUrl:"getCropAttachment.action",cropUrl:"cropAttachment.action",updUrl:"updAttachment.action",delUrl:"delAttachment.action",sortUrl:"sortAttachment.action",loadUrl:"loadAttachment.action",downUrl:"downloadAttachment.action",extraData:{tableName:"",tableKey:"",tableUuid:""},fileLength:1E4,fileNumber:1,allowedTypes:"*",fileExt:null,fileName:"file",dataType:"json",method:"POST",uploadType:"async",imgPreview:!1,width:140,height:180,bottom:!0,fileNameShow:!1,totalInfoShow:!0,defaultImage:"cssui/plugins/jqupload/blank.gif",style:liMethod,onload:null,extraEvent:null,extraPara:null,extraButton:null,buttons:[]},a);var u={},F=this,R=1<d(this).length||isnull(a.extraData.tableUuid);if(R){var v=[];this.each(function(){var a=d(this).attr("data-id");v.push(a);u[a]=[]});a.extraData.tableUuid=v.toString()}else u[a.extraData.tableUuid]=[];d.post(a.loadUrl,a.extraData,function(d){switch(d.result){case 0:var l=d.msg.data.config;a.fileLength=l.fileLength;a.fileNumber=l.fileNumber;a.fileExt=l.fileExt;a.extraPara=l.extraPara;d=d.msg.data.list[0].attachments;if(d instanceof Array)for(l=0;l<d.length;l++){var q=d[l].tableUuid;u[q].push(d[l])}else isnull(d)||(q=d.tableUuid,u[q].push(d));isnull(a.extraPara)||("pic"==a.extraPara.type?(a.width=a.extraPara.width,a.height=a.extraPara.height,a.allowedTypes="image/jpg,image/jpeg,image/png,image/gif",a.imgPreview=1==a.extraPara.imgPreview):isnull(a.extraPara)||"crop"!=a.extraPara.type||(a.width=a.extraPara.width,a.height=a.extraPara.height));G();break;default:$css.alert(d.msg)}},a.dataType);var G=function(){F.each(function(){var h=d(this);d(document);var l={},l=d.extend(l,a.extraData);R&&(l.tableUuid=h.attr("data-id"));var q=0,H=0;h.addClass("jqUploadTemplate");h.addClass(a.style.name);var x=0,I,p={},m={},t=[],y=d('\x3cdiv class\x3d"uploadInfo"\x3e\x3c/div\x3e'),z=d('\x3cdiv class\x3d"pull-left totalStatus"\x3e\x3c/div\x3e'),w=d('\x3cdiv class\x3d"btnUpload '+a.btnAlign+'"\x3e\x3c/div\x3e'),k=d('\x3cbutton type\x3d"button" class\x3d"jquploadButton btn '+a.btnClass+" "+a.btnAlign+'"\x3e \x3ci class\x3d"fa fa-folder-open-o"\x3e\x3c/i\x3e '+a.btnTitle+"\x3c/button\x3e"),v=d('\x3cbutton type\x3d"button" class\x3d"btnSort btn '+a.btnSortClass+" "+a.btnAlign+'"\x3e \x3ci class\x3d"fa fa-arrows-v"\x3e\x3c/i\x3e \u4fdd\u5b58\u987a\u5e8f\x3c/button\x3e'),S={getFiles:function(){return h.find(".jquploadRow")},getTotalFiles:function(){return q},getSuccessFiles:function(){return H},getFileInfo:function(b){b=m[b];isnull(a.extraPara)||(b.extraPara=a.extraPara);return b}},n={onInit:function(b){if(0<b.length){q=b.length;for(var c=0;c<b.length;c++){var d=b[c];d.id=uuid();d.file=null;m[d.id]=d;a.style.addFile(h,d,1,a);a.readonly?A(d.id,3):(B(),A(d.id,1));C(d.id);D()}}else T();J();K();if(!isnull(a.onload))a.onload()},onNewFile:function(b){1==a.fileNumber&&a.style.imageFlag&&h.find("li").remove();a.style.addFile(h,b,0,a);B();C(b.id);D()},onFileTypeError:function(a,c){n.onUploadError(a,"\u4e0d\u5141\u8bb8\u4e0a\u4f20\u8be5\u7c7b\u578b\u6587\u4ef6")},onFileExtError:function(a,c,d){n.onUploadError(a,"\u6587\u4ef6\u6269\u5c55\u540d(."+d+")\u7c7b\u578b\u4e0d\u5141\u8bb8")},onFileSizeError:function(a,c,g){n.onUploadError(a,"\u6587\u4ef6\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7"+d.file.getFileSize(g))},onUploadSuccess:function(b,c){if(0==c.result){d("#"+b).attr("status",1);U(b,"success","\u4e0a\u4f20\u6210\u529f");B();m[b].uuid=c.msg.uuid;m[b].fileUrlFull=c.msg.fileUrlFull;m[b].time=c.msg.time;m[b].userId=c.msg.userId;m[b].file=null;if(isIE6||isIE7||isIE8||isIE9){m[b].fileSize=c.msg.fileSize;var g=d("#"+b).find(".default-file-size");if(g){var f=g.html();isnull(f)?g.html(d.file.getFileSize(m[b].fileSize)):g.html("("+d.file.getFileSize(m[b].fileSize)+")")}}A(b,1);C(b);a.style.imageFlag&&(g=c.msg.fileUrlFull+"."+c.msg.fileExt,1==a.style.background?k.css({background:"#fff url("+g+") no-repeat"}):(f=d("#"+b).find(".iconCell img"),f.attr("src",g),f.attr("class","pic-element"),f.attr("data-original",c.msg.fileUrlFull),K()))}else n.onUploadError(b,c.msg)},onUploadError:function(b,c){d("#"+b).attr("status",2);var g=d('\x3ccode class\x3d"tipsCell" text-red"\x3e'+c+"\x3c/code\x3e"),f=d("#"+b).find(".messageCell");f.find(".tipsCell").remove();f.append(g);U(b,"danger","\u4e0a\u4f20\u5931\u8d25");isnull(c);1==a.fileNumber&&a.style.imageFlag&&$css.alert(c);A(b,2)}},B=function(){q=h.find(".jquploadRow").length;H=h.find(".jquploadRow[status\x3d1]").length;z.html("\u5b8c\u6210/\u603b\u6570\uff1a"+H+"/"+q)},C=function(b){if(null!=a.extraEvent){var c=d("#"+b).find(".default-file-name, img");c&&(c.unbind(),c.css("cursor","pointer"),c.click(function(){var c=S.getFileInfo(b);a.extraEvent(c)}))}},U=function(b,c,g){var f=d("#"+b).find(".statusCell");if(a.style.imageFlag){f.hide();var f=d("#"+b).find("."+c+"Mark"),r=d("#"+b).find(".tipsCell").html(),r=g+(isnull(r)?"":"\uff1a"+r);f.attr("title",r);"danger"==c?(f.css("cursor","pointer"),f.show(),f.click(function(){V(b)})):f.show().delay(8E3).hide(1E3)}else f.html(""),f.append('\x3cspan class\x3d"label label-'+c+'"\x3e'+g+"\x3c/span\x3e")},W=function(b){var c=d("#"+b).find(".statusCell");a.style.imageFlag?(c.html('\x3cdiv class\x3d"progress progress-xs"\x3e\x3cdiv class\x3d"progress-bar progress-bar-success progress-bar-striped" role\x3d"progressbar" \x3e0%\x3c/div\x3e\x3c/div\x3e'),c.show()):c.html('\x3cdiv class\x3d"progress"\x3e\x3cdiv class\x3d"progress-bar" role\x3d"progressbar" style\x3d"min-width:3em;"\x3e0%\x3c/div\x3e\x3c/div\x3e');d("#"+b).find(".toolsCell").html("");d("#"+b).find(".tipsCell").remove()},X=function(b,c){var g=d("#"+b).find("div.progress-bar");g.width(c);a.style.imageFlag?g.html(""):g.html(c)},A=function(b,c){var g=d("#"+b).find(".toolsCell"),f=d('\x3cdiv class\x3d"tools"\x3e\x3c/div\x3e'),r=d('\x3ci class\x3d"fa fa-trash-o" title\x3d"\u5220\u9664"\x3e \x3c/i\x3e'),h=d('\x3ci class\x3d"fa fa-edit" title\x3d"\u7f16\u8f91"\x3e \x3c/i\x3e'),k=d('\x3ci class\x3d"fa fa-download" title\x3d"\u4e0b\u8f7d"\x3e \x3c/i\x3e'),l=d('\x3ci class\x3d"fa fa-reply" title\x3d"\u91cd\u4f20"\x3e \x3c/i\x3e');g.html("").append(f);1==c?(f.append(h),f.append(k),f.append(r)):2==c?(f.append(l),f.append(r)):3==c&&f.append(k);r.click(function(){V(b)});h.click(function(){ba(b)});k.click(function(){ca(b,2)});l.click(function(){b in m&&L(m[b])});d.each(a.buttons,function(a,c){var g=d('\x3ci class\x3d"'+c.icon+'" title\x3d"'+c.title+'"\x3e \x3c/i\x3e');f.append(g);c.action&&g.click(function(){c.action.call(this,S.getFileInfo(b))})})},T=function(){if(1==a.fileNumber&&a.style.imageFlag){var b=m.defaultImageId;isnull(b)&&(b={id:"defaultImageId",file:null,fileName:"",fileSize:"-1",category:"pic"},b.fileUrlFull=a.defaultImage,m[b.id]=b);a.style.addFile(h,b,1,a);(isIE6||isIE7||isIE8||isIE9)&&M()}},F=function(){var b={};b.x=Math.round(p.e.x);b.y=Math.round(p.e.y);b.width=p.e.width;b.height=p.e.height;b.tSessionId=(new Date).valueOf();b=d.param(d.extend(b,l));d.post(a.cropUrl,b,function(b){0==b.result?(1==a.style.background?a.style.setBackground(h,b.msg,a):h.find(".iconCell img").attr("src",b.msg.fileUrlFull+"."+b.msg.fileExt),$css.tip("\u4fdd\u5b58\u6210\u529f\uff01")):$css.alert(b.msg)},a.dataType)},G=function(b){W(b.id);var c=new FormData;c.append(a.fileName,b.file);c.append("name",b.file.name);c.append("fileType",b.file.type);isnull(a.extraPara)||"crop"!=a.extraPara.type?a.style.imageFlag&&(c.append("width",a.width),c.append("height",a.height)):(c.append("x",Math.round(p.e.x)),c.append("y",Math.round(p.e.y)),c.append("width",p.e.width),c.append("height",p.e.height));d.each(l,function(a,b){c.append(a,b)});d.ajax({url:a.uploadUrl,type:a.method,dataType:a.dataType,data:c,cache:!1,contentType:!1,processData:!1,forceSync:!1,xhr:function(){var a=d.ajaxSettings.xhr();a.upload&&a.upload.addEventListener("progress",function(a){var c=0,d=a.loaded||a.position,g=a.total||e.totalSize;a.lengthComputable&&(c=Math.ceil(d/g*100));X(b.id,c+"%")},!1);return a},success:function(a,c,d){n.onUploadSuccess.call(h,b.id,a)},error:function(a,c,d){n.onUploadError.call(h,b.id,d)},complete:function(b,c){"sync"==a.uploadType?N():J()}})},K=function(){1==a.imgPreview&&h.cssViewer({uuid:h.attr("id"),picClass:"pic-element",picData:"data-original",picTitle:"title"})},J=function(){!a.readonly&&a.sortable&&a.style.sortable&&(h.find(".sortable").sortable("destroy"),h.find(".sortable").sortable(),h.find(".sortable").css("cursor","move"),h.find(".sortable").on("dragend",function(){D();a.sortSaveAuto&&O()}))},O=function(){var b="";h.find("li").each(function(){var a=d(this).attr("id");isnull(a)||(a=m[d(this).attr("id")],b+=a.uuid+",")});if(!isnull(b)){var c={};c.sortStr=b;c.tSessionId=(new Date).valueOf();c=d.param(d.extend(c,l));d.post(a.sortUrl,c,function(b){0==b.result?a.sortSaveAuto||$css.tip("\u987a\u5e8f\u4fdd\u5b58\u6210\u529f\uff01"):$css.alert(b.msg)},a.dataType)}},L=function(b){var c=b.file;if("*"!=a.allowedTypes&&0>a.allowedTypes.indexOf(c.type))n.onFileTypeError(b.id,c);else{if(null!=a.fileExt&&"*"!=a.fileExt){var g=a.fileExt.toLowerCase().split(","),f=getFileExt(c.name);if(0>d.inArray(f,g)){n.onFileExtError(b.id,c,f);return}}if(0<a.fileLength&&c.size>1024*a.fileLength)n.onFileSizeError(b.id,c,1024*a.fileLength);else G(b)}},N=function(){x<t.length?L(t[x++]):(J(),k.attr("disabled",!1))},Y=function(a,c){var d={};d.id=uuid();d.fileExt=getFileExt(c.name);d.fileName=c.name.substring(0,c.name.lastIndexOf("."));d.fileSize=c.size;d.file=c;m[d.id]=d;t[a]=d;n.onNewFile(d)},da=function(b){var c=d(b).val(),g=getFileName(c),f={};f.id=uuid();f.fileExt=getFileExt(c);f.fileName=g.substring(0,g.lastIndexOf("."));f.fileSize=0;f.file=null;m[f.id]=f;n.onNewFile(f);c={};(isnull(a.extraPara)||"crop"!=a.extraPara.type)&&a.style.imageFlag&&(c.width=a.width,c.height=a.height);c.ie="ie8";var c=d.extend(c,l),h=null;new IEUpload({action:a.uploadUrl,name:a.fileName,data:c,file:b,responseType:"json",onSubmit:function(b,c){if(null!=a.fileExt&&"*"!=a.fileExt){var g=a.fileExt.toLowerCase().split(",");c=f.fileExt;if(0>d.inArray(c,g))return n.onFileExtError(fm.id,file,c),!1}W(f.id);var k=10;h=setInterval(function(){k+=Math.ceil((100-k)/10);98<k&&clearInterval(h);X(f.id,k+"%")},500)},onComplete:function(b,c){clearInterval(h);n.onUploadSuccess.call(this,f.id,c);isnull(a.extraPara)||"crop"!=a.extraPara.type?M():Z(!0)}})},D=function(){if(!a.fileIcon){var b=1;h.find(".numCell").each(function(){d(this).html(b++ +(a.style.dotFlag?".":""))})}},V=function(b){var c=d("#"+b),g=function(){var f=function(){c.remove();delete m[b];B();D();T();K()};if("1"==c.attr("status")){var g={};g.ids=m[b].uuid;g.tSessionId=(new Date).valueOf();g=d.param(g);d.post(a.delUrl,g,function(a){0==a.result?f():$css.alert(a.msg)},a.dataType)}else f()};a.confirm&&"1"==c.attr("status")?$css.confirm("\u786e\u5b9a\u8981\u5220\u9664\u6587\u4ef6\u5417\uff1f",g):g()},ba=function(b){var c=m[b],g={};g.url=a.getUrl;g.data={uuid:c.uuid};g.rel="attachmentRename";g.title="\u91cd\u547d\u540d";g.callback=function(){var f=d("#getAttachmentForm");f.find("button").click(function(){if(!f.valid())return!1;var g=f.find("#fileName").val();d.post(a.updUrl,f.serialize(),function(a){0==a.result?(closeDialog(),$css.tip("\u4fdd\u5b58\u6210\u529f\uff01"),c.fileName=g,m[b]=c,d("#"+b).find(".default-file-name").html(getFullName(c)),C(b)):$css.alert(a.msg)},a.dataType)})};$css.openDialog(g)},ca=function(b,c){var g=function(){var f={};f.uuid=m[b].uuid;f.mod=c;f.tSessionId=(new Date).valueOf();var f=d.param(f),g=d("#hiddenformwwd");0==g.length&&(d("body").append('\x3cform id\x3d"hiddenformwwd" target\x3d"_blank" method\x3d"post"\x3e\x3c/form\x3e'),g=d("#hiddenformwwd"));g.attr("action",a.downUrl+"?"+f);g.submit()},f=d("#"+b).find(".default-file-name").html(),f=isnull(f)?"":"\u201c"+f+"\u201d";a.confirm?$css.confirm("\u786e\u5b9a\u8981\u4e0b\u8f7d\u6587\u4ef6"+f+"\u5230\u672c\u5730\u5417\uff1f",g):g()},E=function(a){return isNumber(a)?a+"px":a},aa=function(b){if(isIE6||isIE7||isIE8||isIE9){var c=19.001*k.outerWidth()/100,d=k.position();b.css({position:"absolute",display:"",width:E(k.outerWidth()),height:E(k.outerHeight()),left:E(d.left),cursor:"pointer",color:"transparent","font-size":c+"px","z-index":201707,overflow:"hidden",opacity:0});1==a.fileNumber&&"center-block"==a.btnAlign&&1!=a.style.background&&b.css({"margin-top":E(-k.outerHeight())});k.unbind();k.hover(function(){aa(b)})}},M=function(){var b=w.find("input[name\x3d'"+a.fileName+"']");0<b.length&&b.remove();b=d('\x3cinput type\x3d"file" name\x3d"'+a.fileName+'" style\x3d"display:none" unselectable\x3d"on" '+("*"!=a.allowedTypes?'accept\x3d"'+a.allowedTypes+'"':"")+(1!=a.fileNumber?' multiple\x3d"multiple"':" ")+"/\x3e");k.after(b);aa(b);b.click(function(b){if(0<a.fileNumber&&q>=a.fileNumber)return $css.alert("\u6700\u591a\u5141\u8bb8\u4e0a\u4f20 "+a.fileNumber+" \u4e2a\u9644\u4ef6\uff01"),b.stopPropagation(),!1});b.on("change",function(b){k.attr("disabled",!0);if(isIE6||isIE7||isIE8||isIE9)da(this);else{I=b.target.files;t=[];for(b=0;b<I.length&&!(0<a.fileNumber&&q>=a.fileNumber);b++)Y(b,I[b]);if("sync"==a.uploadType)x=0,N();else{for(b=0;b<t.length;b++)L(t[b]);k.attr("disabled",!1)}}d(this).val("")});k.attr("disabled",!1);return b},Q=function(){P();var b=M();a.style.sortable&&a.sortable&&!a.sortSaveAuto&&(w.append(v),v.click(function(){a.confirm?$css.confirm("\u786e\u5b9a\u8981\u4fdd\u5b58\u5f53\u524d\u6392\u5e8f\u5417\uff1f",O):O()}));isIE6||isIE7||isIE8||isIE9||k.click(function(){b.click()})},Z=function(b){isIE6||isIE7||isIE8||isIE9?(k.unbind(),k.attr("disabled",!1)):P();k.click(function(){var b={};b.url=a.getCropUrl;b.data=l;b.rel="getCropFile";b.title="\u56fe\u7247\u526a\u88c1";b.callback=function(){d("#getCropAttachmentForm").find(".crop-save").click(function(){p=$cropApp.saveClick();isnull(p)||($css.closeDialog(),t=[],isnull(p.file)?F():(Y(0,p.file),x=0,N()))})};$css.openDialog(b)});b&&k.click()},P=function(){w.append(k);1==a.style.background&&(a.defaultBackground=k.css("background-image"),a.defaultFilter=k.css("filter"),k.css({width:a.width,height:a.height}))};(function(){h.html("");"pull-right"==a.btnAlign?y.append(z).append(w).append('\x3cdiv style\x3d"clear: both;"\x3e\x3c/div\x3e'):y.append(w).append(z).append('\x3cdiv style\x3d"clear: both;"\x3e\x3c/div\x3e');a.btnOnTop?(a.readonly||h.append(y),h.append(d(a.style.getTemplate(a)))):(h.append(d(a.style.getTemplate(a))),a.readonly||h.append(y));a.totalInfoShow||z.hide();var b=u[l.tableUuid];isnull(a.extraPara)?a.readonly||Q():"pic"==a.extraPara.type?a.readonly||Q():isnull(a.extraPara)||"crop"!=a.extraPara.type||a.readonly||(0==b.length&&(isIE6||isIE7||isIE8||isIE9)?Q():(P(),Z(!1)));n.onInit(b)})()})}}})(jQuery);